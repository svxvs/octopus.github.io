---
layout: post
title:  "深入PHP变量存储结构（转）"
date:   2015-10-26 16:41:03 +0800
categories: jekyll update
---



<div id="article_content" class="article_content">

<p>首先声明，我并没有去读<a href="http://lib.csdn.net/base/36" class="replace_word" title="PHP知识库" target="_blank" style="color:#df3434; font-weight:bold;">PHP</a>的源码，只是对于PHP的有时候诡异的表现感兴趣，找了一下开发人员<a target="_blank" href="http://http://www.laruence.com/">laruence</a>的博客结合PHP提供的函数debug_zval_dump刺探得到了本博客所阐述的工作机理。如果你想对PHP变量存储结构有一个了解或想对PHP变量加深理解的话，本文是适合你的，比较深入的去看源代码吧。</p>
<p>为了保证博客的连贯性，首先引用laruence关于<a target="_blank" href="http://http://www.laruence.com/2008/08/22/412.html">PHP变量内部存储结构</a>的部分内容(稍作修改)</p>
<p></p>
<hr>
<p></p>
<p style="margin-top:0px; margin-bottom:1.5em; padding-top:0px; padding-bottom:0px; border:0px; font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; vertical-align:baseline; text-indent:1em; color:rgb(34,34,34); line-height:18px">
在PHP中，所有的变量都是用一个结构-zval来保存的， 在Zend/zend.h中我们可以看到zval的定义：</p>
<pre name="code" class="sh_cpp sh_sourceCode" linenum="off" style="margin-top: 1.5em; margin-bottom: 1.5em; padding: 9px; border-width: 0px 0px 0px 15px; border-left-style: solid; border-left-color: rgb(201, 201, 201); font-family: Monaco, Consolas, Courier, monospace; vertical-align: baseline; line-height: 18px; background-color: rgb(51, 51, 51); color: rgb(246, 243, 232); overflow-x: auto;"><ol style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline; list-style-type: none;"><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">&nbsp;&nbsp;<span class="sh_keyword" style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; vertical-align: baseline; color: rgb(150, 203, 254);">typedef</span> <span class="sh_keyword" style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; vertical-align: baseline; color: rgb(150, 203, 254);">struct</span><span class="sh_normal" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;"> </span><span class="sh_classname" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">_zval_struct</span> <span class="sh_cbracket" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">{</span></li><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_usertype" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">zvalue_value</span><span class="sh_normal" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;"> </span>value<span class="sh_symbol" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">;</span></li><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_usertype" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">zend_uint</span><span class="sh_normal" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;"> </span>refcount<span class="sh_symbol" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">;</span></li><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_usertype" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">zend_uchar</span><span class="sh_normal" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;"> </span>type<span class="sh_symbol" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">;</span></li><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_usertype" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">zend_uchar</span><span class="sh_normal" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;"> </span>is_ref<span class="sh_symbol" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">;</span></li><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">&nbsp;&nbsp;<span class="sh_cbracket" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">}</span> zval<span class="sh_symbol" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">;</span></li><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">&nbsp;</li></ol></pre>
<p style="margin-top:0px; margin-bottom:1.5em; padding-top:0px; padding-bottom:0px; border:0px; font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; vertical-align:baseline; text-indent:1em; color:rgb(34,34,34); line-height:18px">
其中zvalue_value是真正保存数据的关键部分，定义为一个联合体(union)</p>
<pre name="code" class="sh_cpp sh_sourceCode" linenum="off" style="margin-top: 1.5em; margin-bottom: 1.5em; padding: 9px; border-width: 0px 0px 0px 15px; border-left-style: solid; border-left-color: rgb(201, 201, 201); font-family: Monaco, Consolas, Courier, monospace; vertical-align: baseline; line-height: 18px; background-color: rgb(51, 51, 51); color: rgb(246, 243, 232); overflow-x: auto;"><ol style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline; list-style-type: none;"><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;"><span class="sh_keyword" style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; vertical-align: baseline; color: rgb(150, 203, 254);">typedef</span> <span class="sh_keyword" style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; vertical-align: baseline; color: rgb(150, 203, 254);">union</span> _zvalue_value <span class="sh_cbracket" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">{</span></li><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_type" style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; vertical-align: baseline; color: rgb(255, 255, 182);">long</span> lval<span class="sh_symbol" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">;</span></li><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_type" style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; vertical-align: baseline; color: rgb(255, 255, 182);">double</span> dval<span class="sh_symbol" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">;</span></li><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_keyword" style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; vertical-align: baseline; color: rgb(150, 203, 254);">struct</span> <span class="sh_cbracket" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">{</span></li><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_type" style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; vertical-align: baseline; color: rgb(255, 255, 182);">char</span> <span class="sh_symbol" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">*</span>val<span class="sh_symbol" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">;</span></li><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_type" style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; vertical-align: baseline; color: rgb(255, 255, 182);">int</span> len<span class="sh_symbol" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">;</span></li><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_cbracket" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">}</span> str<span class="sh_symbol" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">;</span></li><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_usertype" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">HashTable</span><span class="sh_normal" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;"> </span><span class="sh_symbol" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">*</span>ht<span class="sh_symbol" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">;</span></li><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_usertype" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">zend_object_value</span><span class="sh_normal" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;"> </span>obj<span class="sh_symbol" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">;</span></li><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;"><span class="sh_cbracket" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">}</span> zvalue_value<span class="sh_symbol" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">;</span></li></ol></pre>
<p style="margin-top:0px; margin-bottom:1.5em; padding-top:0px; padding-bottom:0px; border:0px; font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; vertical-align:baseline; text-indent:1em; color:rgb(34,34,34); line-height:18px">
PHP中常见的变量类型有：</p>
<pre name="code" class="sh_shell" linenum="off" style="margin-top: 1.5em; margin-bottom: 1.5em; padding: 9px; border-width: 0px 0px 0px 15px; border-left-style: solid; border-left-color: rgb(201, 201, 201); font-family: Monaco, Consolas, Courier, monospace; vertical-align: baseline; line-height: 18px; background-color: rgb(51, 51, 51); color: rgb(217, 217, 217); overflow-x: auto;"><ol style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline; list-style-type: none;"><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">1. 整型/浮点/长整型/bool值 等等</li><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">2. 字符串</li><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">3. 数组/关联数组</li><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">4. 对象</li><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">5. 资源</li><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">&nbsp;</li></ol></pre>
<p style="margin-top:0px; margin-bottom:1.5em; padding-top:0px; padding-bottom:0px; border:0px; font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; vertical-align:baseline; text-indent:1em; color:rgb(34,34,34); line-height:18px">
PHP根据zval中的type字段来储存一个变量的真正类型，然后根据type来选择如何获取zvalue_value的值，比如对于整型和bool值:</p>
<pre name="code" class="sh_shell" linenum="off" style="margin-top: 1.5em; margin-bottom: 1.5em; padding: 9px; border-width: 0px 0px 0px 15px; border-left-style: solid; border-left-color: rgb(201, 201, 201); font-family: Monaco, Consolas, Courier, monospace; vertical-align: baseline; line-height: 18px; background-color: rgb(51, 51, 51); color: rgb(217, 217, 217); overflow-x: auto;"><ol style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline; list-style-type: none;"><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">&nbsp;&nbsp;&nbsp;zval.type = IS_LONG;//整形</li><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">&nbsp;&nbsp;&nbsp;zval.type = IS_BOOL;//布尔值</li></ol></pre>
<p style="margin-top:0px; margin-bottom:1.5em; padding-top:0px; padding-bottom:0px; border:0px; font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; vertical-align:baseline; text-indent:1em; color:rgb(34,34,34); line-height:18px">
就去取zval.value.lval,对于bool值来说lval∈(0|1);如果是双精度，或者float则会去取zval.value的dval。而如果是字符串，那么:</p>
<pre name="code" class="sh_shell" linenum="off" style="margin-top: 1.5em; margin-bottom: 1.5em; padding: 9px; border-width: 0px 0px 0px 15px; border-left-style: solid; border-left-color: rgb(201, 201, 201); font-family: Monaco, Consolas, Courier, monospace; vertical-align: baseline; line-height: 18px; background-color: rgb(51, 51, 51); color: rgb(217, 217, 217); overflow-x: auto;"><ol style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline; list-style-type: none;"><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">&nbsp;&nbsp;&nbsp;zval.type = IS_STRING</li></ol></pre>
<p style="margin-top:0px; margin-bottom:1.5em; padding-top:0px; padding-bottom:0px; border:0px; font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; vertical-align:baseline; text-indent:1em; color:rgb(34,34,34); line-height:18px">
这个时候，就会取:zval.value.str而这个也是个结构，存有C分格的字符串和字符串的长度。</p>
<p style="margin-top:0px; margin-bottom:1.5em; padding-top:0px; padding-bottom:0px; border:0px; font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; vertical-align:baseline; text-indent:1em; color:rgb(34,34,34); line-height:18px">
<span style="text-indent:1em">而对于数组和对象，则type分别对应IS_ARRAY, IS_OBJECT, 相对应的则分别取zval.value.ht和obj</span></p>
<p style="margin-top:0px; margin-bottom:1.5em; padding-top:0px; padding-bottom:0px; border:0px; font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; vertical-align:baseline; text-indent:1em; color:rgb(34,34,34); line-height:18px">
比较特别的是资源，在PHP中，资源是个很特别的变量，任何不属于PHP内建的变量类型的变量，都会被看作成资源来进行保存，比如，<a href="http://lib.csdn.net/base/14" class="replace_word" title="MySQL知识库" target="_blank" style="color:#df3434; font-weight:bold;">数据库</a>句柄，打开的文件句柄等等。 对于资源:</p>
<pre name="code" class="sh_php sh_sourceCode" linenum="off" style="margin-top: 1.5em; margin-bottom: 1.5em; padding: 9px; border-width: 0px 0px 0px 15px; border-left-style: solid; border-left-color: rgb(201, 201, 201); font-family: Monaco, Consolas, Courier, monospace; vertical-align: baseline; line-height: 18px; background-color: rgb(51, 51, 51); color: rgb(246, 243, 232); overflow-x: auto;"><ol style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline; list-style-type: none;"><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">&nbsp;&nbsp;&nbsp;type <span class="sh_symbol" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">=</span> IS_RESOURCE</li></ol></pre>
<p style="margin-top:0px; margin-bottom:1.5em; padding-top:0px; padding-bottom:0px; border:0px; font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; vertical-align:baseline; text-indent:1em; line-height:18px">
<span style="color:#ff0000">这个时候，会去取zval.value.lval， 此时的lval是个整型的指示器， 然后PHP会再根据这个指示器在PHP内建的一个资源列表中查询相对应的资源，此时的lval就好像是对应于资源链表的偏移值。</span></p>
<pre name="code" class="sh_php sh_sourceCode" linenum="off" style="margin-top: 1.5em; margin-bottom: 1.5em; padding: 9px; border-width: 0px 0px 0px 15px; border-left-style: solid; border-left-color: rgb(201, 201, 201); font-family: Monaco, Consolas, Courier, monospace; vertical-align: baseline; line-height: 18px; background-color: rgb(51, 51, 51); color: rgb(246, 243, 232); overflow-x: auto;"><ol style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline; list-style-type: none;"><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">&nbsp;<span class="sh_function" style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; vertical-align: baseline; color: rgb(255, 210, 167);">ZEND_FETCH_RESOURCE</span><span class="sh_symbol" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">(</span>con<span class="sh_symbol" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">,</span> type<span class="sh_symbol" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">,</span> zval <span class="sh_symbol" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">*,</span> <span class="sh_keyword" style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; vertical-align: baseline; color: rgb(150, 203, 254);">default</span><span class="sh_symbol" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">,</span> resource_name<span class="sh_symbol" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">,</span> resource_type<span class="sh_symbol" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">);</span></li></ol></pre>
<p style="margin-top:0px; margin-bottom:1.5em; padding-top:0px; padding-bottom:0px; border:0px; font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; vertical-align:baseline; text-indent:1em; color:rgb(34,34,34); line-height:18px">
借用这样的机制，PHP就实现了弱类型，因为对于ZE的来说，它所面对的永远都是同一种类型，那就是zval。</p>
<hr>
<p>上面部分博文只是阐明了PHP变量的内部表示，要想知道<span style="color:rgb(34,34,34); font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; line-height:18px; text-indent:12px">内部表示是如何和用户脚本中的变量联系起来的，需要看laruence的另一篇博文<a target="_blank" href="http://http://www.laruence.com/2008/08/26/463.html">深入理解PHP原理之变量作用域(Scope
 in PHP)</a>,同样引用部分内容(稍作修改)如下</span><span style="color:rgb(34,34,34); font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; line-height:18px; text-indent:12px">:</span></p>
<p><span style="color:rgb(34,34,34); font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; line-height:18px; text-indent:12px"><br>
</span></p>
<span style="color:rgb(34,34,34); font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; line-height:18px"></span>
<hr>
<p style="margin-top:0px; margin-bottom:1.5em; padding-top:0px; padding-bottom:0px; border:0px; font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; vertical-align:baseline; text-indent:1em; color:rgb(34,34,34); line-height:18px">
如果在脚本中写下：</p>
<pre name="code" class="sh_php sh_sourceCode" linenum="off" style="margin-top: 1.5em; margin-bottom: 1.5em; padding: 9px; border-width: 0px 0px 0px 15px; border-left-style: solid; border-left-color: rgb(201, 201, 201); font-family: Monaco, Consolas, Courier, monospace; vertical-align: baseline; line-height: 18px; background-color: rgb(51, 51, 51); color: rgb(246, 243, 232); overflow-x: auto;"><ol style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline; list-style-type: none;"><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;"><span class="sh_symbol" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">&lt;?php</span></li><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">&nbsp;&nbsp;<span class="sh_variable" style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; vertical-align: baseline; color: rgb(198, 197, 254);">$var</span> <span class="sh_symbol" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">=</span> <span class="sh_string" style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; vertical-align: baseline; color: rgb(168, 255, 96);">"laruence"</span><span class="sh_symbol" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">;</span></li><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">&nbsp;&nbsp;<span class="sh_keyword" style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; vertical-align: baseline; color: rgb(150, 203, 254);">echo</span> <span class="sh_variable" style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; vertical-align: baseline; color: rgb(198, 197, 254);">$var</span><span class="sh_symbol" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">;</span></li><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;"><span class="sh_symbol" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">?&gt;</span></li></ol></pre>
<p style="margin-top:0px; margin-bottom:1.5em; padding-top:0px; padding-bottom:0px; border:0px; font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; vertical-align:baseline; text-indent:1em; color:rgb(34,34,34); line-height:18px">
ZE是如何把我的变量var和内部结构zval联系起来的呢？</p>
<p style="margin-top:0px; margin-bottom:1.5em; padding-top:0px; padding-bottom:0px; border:0px; font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; vertical-align:baseline; text-indent:1em; color:rgb(34,34,34); line-height:18px">
PHP内部都是使用zval来表示变量的，但是对于上面的脚本，我们的变量是有名字的, var。而zval中并没有相应的字段来体现变量名。PHP内部一定有一个机制，来实现变量名到zval的映射。</p>
<p style="margin-top:0px; margin-bottom:1.5em; padding-top:0px; padding-bottom:0px; border:0px; font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; vertical-align:baseline; text-indent:1em; color:rgb(34,34,34); line-height:18px">
在PHP中，所有的变量都会存储在一个数组中(确切的说是hash table)。</p>
<p style="margin-top:0px; margin-bottom:1.5em; padding-top:0px; padding-bottom:0px; border:0px; font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; vertical-align:baseline; text-indent:1em; line-height:18px">
<span style="color:rgb(34,34,34)">当你创建一个变量的时候，PHP会为这个变量</span><span style="color:#ff0000">分配一个zval</span><span style="color:rgb(34,34,34)">，填入相应的变量值，然后将这个</span><span style="color:#ff0000">变量的名字</span><span style="color:rgb(34,34,34)">，和指向这个zval的</span><span style="color:#ff0000">指针</span><span style="color:#222222">填入一个数组中。然后，当你获取这个变量的时候，PHP会通过查找这个数组，获得对应的zval。</span></p>
<p style="margin-top:0px; margin-bottom:1.5em; padding-top:0px; padding-bottom:0px; border:0px; font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; vertical-align:baseline; text-indent:1em; color:rgb(34,34,34); line-height:18px">
查看_zend_executor_globals结构(这个结构在PHP的执行器保存一些执行相关的上下文信息)</p>
<pre name="code" class="sh_cpp sh_sourceCode" linenum="off" style="margin-top: 1.5em; margin-bottom: 1.5em; padding: 9px; border-width: 0px 0px 0px 15px; border-left-style: solid; border-left-color: rgb(201, 201, 201); font-family: Monaco, Consolas, Courier, monospace; vertical-align: baseline; line-height: 18px; background-color: rgb(51, 51, 51); color: rgb(246, 243, 232); overflow-x: auto;"><ol style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline; list-style-type: none;"><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;"><span class="sh_keyword" style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; vertical-align: baseline; color: rgb(150, 203, 254);">struct</span><span class="sh_normal" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;"> </span><span class="sh_classname" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">_zend_executor_globals</span> <span class="sh_cbracket" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">{</span></li><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">&nbsp;</li><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_symbol" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">....</span></li><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_usertype" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">HashTable</span><span class="sh_normal" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;"> </span><span class="sh_symbol" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">*</span>active_symbol_table<span class="sh_symbol" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">;</span><span class="sh_comment" style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; vertical-align: baseline; color: rgb(124, 124, 124);">/*活动符号表*/</span></li><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_usertype" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">HashTable</span><span class="sh_normal" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;"> </span>symbol_table<span class="sh_symbol" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">;</span>     <span class="sh_comment" style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; vertical-align: baseline; color: rgb(124, 124, 124);">/*全局符号表*/</span></li><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">&nbsp;</li><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_usertype" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">HashTable</span><span class="sh_normal" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;"> </span>included_files<span class="sh_symbol" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">;</span>   </li><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">&nbsp;</li><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_usertype" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">jmp_buf</span><span class="sh_normal" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;"> </span><span class="sh_symbol" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">*</span>bailout<span class="sh_symbol" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">;</span></li><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_type" style="margin: 0px; padding: 0px; border: 0px; font-family: inherit; vertical-align: baseline; color: rgb(255, 255, 182);">int</span> error_reporting<span class="sh_symbol" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">;</span></li><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sh_symbol" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">.....</span></li><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;"><span class="sh_cbracket" style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">}</span></li><li style="margin: 0px; padding: 0px; border: 0px; font-style: inherit; font-family: inherit; vertical-align: baseline;">&nbsp;</li></ol></pre>
<hr>
<p>总结以上两篇博客，对于如下程序</p>
<p></p>
<div class="dp-highlighter bg_php"><div class="bar"><div class="tools"><b>[php]</b> <a href="#" class="ViewSource" title="view plain" onclick="dp.sh.Toolbar.Command('ViewSource',this);return false;">view plain</a><span data-mod="popu_168"> <a href="#" class="CopyToClipboard" title="copy" onclick="dp.sh.Toolbar.Command('CopyToClipboard',this);return false;">copy</a><div style="position: absolute; left: 476px; top: 2646px; width: 23px; height: 12px; z-index: 99;"><embed id="ZeroClipboardMovie_1" src="http://static.blog.csdn.net/scripts/ZeroClipboard/ZeroClipboard.swf" loop="false" menu="false" quality="best" bgcolor="#ffffff" name="ZeroClipboardMovie_1" allowscriptaccess="always" allowfullscreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="id=1&amp;width=23&amp;height=12" wmode="transparent" width="23" align="middle" height="12"></div></span><span data-mod="popu_169"> <a href="#" class="PrintSource" title="print" onclick="dp.sh.Toolbar.Command('PrintSource',this);return false;">print</a></span><a href="#" class="About" title="?" onclick="dp.sh.Toolbar.Command('About',this);return false;">?</a></div></div><ol start="1" class="dp-c"><li class="alt"><span><span>&lt;?php&nbsp;&nbsp;</span></span></li><li class=""><span><span class="keyword">class</span><span>&nbsp;class1&nbsp;&nbsp;</span></span></li><li class="alt"><span>{&nbsp;&nbsp;</span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span><span>&nbsp;</span><span class="vars">$member</span><span>;&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">function</span><span>&nbsp;__construct()&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;</span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="vars">$this</span><span>-&gt;member&nbsp;=&nbsp;1;&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li class=""><span>}&nbsp;&nbsp;</span></li><li class="alt"><span>&nbsp;&nbsp;</span></li><li class=""><span><span class="vars">$a</span><span>&nbsp;=&nbsp;1;&nbsp;&nbsp;</span></span></li><li class="alt"><span><span class="vars">$b</span><span>&nbsp;=&nbsp;0.56;&nbsp;&nbsp;</span></span></li><li class=""><span><span class="vars">$c</span><span>&nbsp;=&nbsp;</span><span class="string">"string"</span><span>;&nbsp;&nbsp;</span></span></li><li class="alt"><span><span class="vars">$d</span><span>&nbsp;=&nbsp;</span><span class="keyword">array</span><span>(1=&gt;1);&nbsp;&nbsp;</span></span></li><li class=""><span><span class="vars">$e</span><span>&nbsp;=&nbsp;</span><span class="keyword">new</span><span>&nbsp;class1;&nbsp;&nbsp;</span></span></li><li class="alt"><span><span class="vars">$f</span><span>&nbsp;=&nbsp;tmpfile();&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;</span></li><li class="alt"><span>debug_zval_dump(<span class="vars">$a</span><span>);&nbsp;&nbsp;</span></span></li><li class=""><span>debug_zval_dump(<span class="vars">$b</span><span>);&nbsp;&nbsp;</span></span></li><li class="alt"><span>debug_zval_dump(<span class="vars">$c</span><span>);&nbsp;&nbsp;</span></span></li><li class=""><span>debug_zval_dump(<span class="vars">$d</span><span>);&nbsp;&nbsp;</span></span></li><li class="alt"><span>debug_zval_dump(<span class="vars">$e</span><span>);&nbsp;&nbsp;</span></span></li><li class=""><span>debug_zval_dump(<span class="vars">$f</span><span>);&nbsp;&nbsp;</span></span></li><li class="alt"><span>?&gt;&nbsp;&nbsp;</span></li></ol><div class="save_code tracking-ad" data-mod="popu_249" style="display: none;"><a href="javascript:;" target="_blank"><img src="http://static.blog.csdn.net/images/save_snippets.png"></a></div></div><pre name="code" class="php" style="display: none;">&lt;?php
class class1
{
	public $member;
	
	function __construct()
	{
		$this-&gt;member = 1;
	}
}

$a = 1;
$b = 0.56;
$c = "string";
$d = array(1=&gt;1);
$e = new class1;
$f = tmpfile();

debug_zval_dump($a);
debug_zval_dump($b);
debug_zval_dump($c);
debug_zval_dump($d);
debug_zval_dump($e);
debug_zval_dump($f);
?&gt;</pre>该程序使用debug_zval_dump刺探LONG、DOUBLE、STRING、ARRAY、OBJECT、RESOURCE类型变量，结果如下
<p></p>
<p></p>
<div class="dp-highlighter bg_plain"><div class="bar"><div class="tools"><b>[plain]</b> <a href="#" class="ViewSource" title="view plain" onclick="dp.sh.Toolbar.Command('ViewSource',this);return false;">view plain</a><span data-mod="popu_168"> <a href="#" class="CopyToClipboard" title="copy" onclick="dp.sh.Toolbar.Command('CopyToClipboard',this);return false;">copy</a><div style="position: absolute; left: 482px; top: 3185px; width: 23px; height: 12px; z-index: 99;"><embed id="ZeroClipboardMovie_2" src="http://static.blog.csdn.net/scripts/ZeroClipboard/ZeroClipboard.swf" loop="false" menu="false" quality="best" bgcolor="#ffffff" name="ZeroClipboardMovie_2" allowscriptaccess="always" allowfullscreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="id=2&amp;width=23&amp;height=12" wmode="transparent" width="23" align="middle" height="12"></div></span><span data-mod="popu_169"> <a href="#" class="PrintSource" title="print" onclick="dp.sh.Toolbar.Command('PrintSource',this);return false;">print</a></span><a href="#" class="About" title="?" onclick="dp.sh.Toolbar.Command('About',this);return false;">?</a></div></div><ol start="1"><li class="alt"><span><span>long(1)&nbsp;refcount(2)&nbsp;&nbsp;</span></span></li><li class=""><span>double(0.56)&nbsp;refcount(2)&nbsp;&nbsp;</span></li><li class="alt"><span>string(6)&nbsp;"string"&nbsp;refcount(2)&nbsp;&nbsp;</span></li><li class=""><span>array(1)&nbsp;refcount(2){&nbsp;&nbsp;</span></li><li class="alt"><span>&nbsp;&nbsp;[1]=&gt;&nbsp;&nbsp;</span></li><li class=""><span>&nbsp;&nbsp;long(1)&nbsp;refcount(1)&nbsp;&nbsp;</span></li><li class="alt"><span>}&nbsp;&nbsp;</span></li><li class=""><span>object(class1)#1&nbsp;(1)&nbsp;refcount(2){&nbsp;&nbsp;</span></li><li class="alt"><span>&nbsp;&nbsp;["member"]=&gt;&nbsp;&nbsp;</span></li><li class=""><span>&nbsp;&nbsp;long(1)&nbsp;refcount(1)&nbsp;&nbsp;</span></li><li class="alt"><span>}&nbsp;&nbsp;</span></li><li class=""><span>resource(4)&nbsp;of&nbsp;type&nbsp;(stream)&nbsp;refcount(2)&nbsp;&nbsp;</span></li></ol><div class="save_code tracking-ad" data-mod="popu_249" style="display: none;"><a href="javascript:;" target="_blank"><img src="http://static.blog.csdn.net/images/save_snippets.png"></a></div></div><pre name="code" class="plain" style="display: none;">long(1) refcount(2)
double(0.56) refcount(2)
string(6) "string" refcount(2)
array(1) refcount(2){
  [1]=&gt;
  long(1) refcount(1)
}
object(class1)#1 (1) refcount(2){
  ["member"]=&gt;
  long(1) refcount(1)
}
resource(4) of type (stream) refcount(2)</pre>分析绘制整个存储结构如下<br>
<img src="http://img.blog.csdn.net/20131120205527281?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvd2VuemhvdTEyMTk=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt=""><br>
<p></p>
<p>对照此图就可以知道PHP各种类型的变量在内存中存储结构和用户变量如何跟内存结构挂钩，了解了这些是下一篇博文关于PHP引用详解的基础。期待下一篇PHP的赋值行为详解吧。</p>
<p><br>
</p>
<p>原创，转载请注明来自<a target="_blank" href="http://blog.csdn.net/wenzhou1219">http://blog.csdn.net/wenzhou1219</a><br>
</p>
   
</div>