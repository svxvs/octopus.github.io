---
layout: post
title:  "PHP内核的存储机制（分离/改变）（转） "
date:   2015-10-26 16:41:03 +0800
categories: jekyll update
---

<div id="article_content" class="article_content">

<p></p>
<div style="font-family:微软雅黑; line-height:21px; widows:auto"><span style="background-color:inherit"><span style="white-space:pre"></span></span>
<div style="font-family:微软雅黑; line-height:21px; widows:auto"><span style="font-size:18px"></span></div>
<span style="font-family:微软雅黑; font-size:14px; line-height:21px; widows:auto"><span style="font-size:18px; background-color:inherit"></span></span>
<div style="line-height:1.875; font-size:12px; font-weight:normal"><span style="background-color:inherit; font-size:18px">前言：</span></div>
<div style="line-height:1.875; font-size:12px; font-weight:normal"><span style="background-color:inherit; font-size:18px">大部分程序员看博客可能不是太喜欢看汉字比较多的文章哈，但本文确实介绍以汉字为主描述，耐心看完，对大部分人来说肯定会有收获！</span></div>
<div style="font-family:微软雅黑; line-height:21px; widows:auto"><span style="font-size:18px"></span></div>
<div style="font-family:微软雅黑; line-height:21px; widows:auto"><span style="font-size:18px"><br>
</span></div>
<span style="font-size:14px; white-space:pre"></span><span style="font-size:14px">或许你知道，或许你不知道，PHP是一个弱类型，动态的脚本语言。所谓弱类型，就是说PHP并不严格验证变量类型(严格来讲，PHP是一个中强类型语言)，在申明一个变量的时候，并不需要显示指明它保存的数据的类型。比如：</span><span style="font-size:14px; widows:auto; background-color:inherit"><span style="background-color:inherit"><span style="color:#00b050; background-color:inherit">$a
 = 1; (整形)<span style="background-color:inherit"> </span>$a ="1";(字符串)</span></span></span></div>
<div style="font-family:微软雅黑; font-size:14px; line-height:21px; widows:auto">
<p style="margin-top:5px; margin-bottom:5px; background-color:inherit"><span style="white-space:pre"><span style="font-family:微软雅黑; font-size:14px; line-height:21px; white-space:pre"><span style="font-family:微软雅黑; font-size:14px; line-height:21px; white-space:pre"></span><span style="font-family:微软雅黑; font-size:14px; line-height:21px">一直使用<a href="http://lib.csdn.net/base/36" class="replace_word" title="PHP知识库" target="_blank" style="color:#df3434; font-weight:bold;">PHP</a>，但它究竟什么，底层是怎么实现才成就了PHP这样方便快捷的弱类型语言。</span></span><span style="font-family:微软雅黑; font-size:14px; line-height:21px">&nbsp;</span></span></p>
<p style="margin-top:5px; margin-bottom:5px; background-color:inherit"><span style="white-space:pre"></span>最近也查阅了很多书籍，还有相关博客资料，了解到了许多关于PHP内核的一些机制。<br>
<br style="font-family:微软雅黑; font-size:14px; line-height:21px">
<span style="font-family:微软雅黑; font-size:14px; line-height:21px"><span style="white-space:pre"></span><span style="color:#990000">php简单的理解就是一个c语言的类库，你去php.net 下面下载一下它的源代码就会发现，首先php的内核是zend engine ，它是一个用c语言写的函数库，用于处理底层的函数管理，内存管理，类管理，和变量管理。在内核上面，他们写了很多扩展，这些扩展大多数都是独立的。用操作系统来比喻的话，zend
 engine 就是一个操作系统，然后官方提供了很多“应用程序”，只是这个“应用程序” 不是media play 而是 <a href="http://lib.csdn.net/base/14" class="replace_word" title="MySQL知识库" target="_blank" style="color:#df3434; font-weight:bold;">MySQL</a> ， libxml，dom。当然，你也可以根据zend engine 的api 开发自己的扩展。</span></span></p>
</div>
<div style="font-family:微软雅黑; line-height:21px; widows:auto">
<p style="font-size:14px; margin-top:5px; margin-bottom:5px; background-color:inherit">
</p>
<div>
<hr style="font-size:14px; background-color:inherit">
<div style="font-family:微软雅黑; line-height:21px; widows:auto; background-color:inherit">
<div style="font-family:微软雅黑; line-height:21px; widows:auto">
<div style="font-size:14px; font-family:微软雅黑; line-height:21px; widows:auto"><br>
</div>
<span style="font-family:微软雅黑; line-height:21px"><span style="font-size:18px"><strong>下边开始介绍下PHP变量在内核中的存储机制。</strong></span></span><br>
</div>
</div>
<div style="font-family:微软雅黑; line-height:21px; widows:auto"><br>
<div style="font-size:14px; font-family:微软雅黑; line-height:21px; background-color:inherit">
<span style="white-space:pre"></span>PHP是若类型语言，也就是说一个PHP变量可以保存任何的数据类型。但PHP是使用C语言编写的，而C语言是强类型语言是吧，每个变量都会有固定的类型，(一颗通过强类型转变，不过有可能出现问题)，那在Zend引擎中如何做到一个变量保存任何数据类型？下边请看它存储结构体。</div>
<div style="font-family:微软雅黑; line-height:21px"><span style="font-size:14px; background-color:inherit">打开Zend/zend.h头文件，会发现下列结构体</span><span style="font-size:24px"><span style="background-color:rgb(255,153,0)">Zval</span></span><span style="font-size:14px; background-color:inherit">：</span></div>
</div>
</div>
</div>
<span style="white-space:pre"></span>
<p></p>
<p>1.zval结构</p>
<p><span style="white-space:pre"></span></p>
<div class="dp-highlighter bg_php"><div class="bar" style="display: block;"><div class="tools"><b>[php]</b> <a href="#" class="ViewSource" title="view plain" onclick="dp.sh.Toolbar.Command('ViewSource',this);return false;">view plain</a><span data-mod="popu_168"> <a href="#" class="CopyToClipboard" title="copy" onclick="dp.sh.Toolbar.Command('CopyToClipboard',this);return false;">copy</a><div style="position: absolute; left: 428px; top: 1046px; width: 23px; height: 12px; z-index: 99;"><embed id="ZeroClipboardMovie_1" src="http://static.blog.csdn.net/scripts/ZeroClipboard/ZeroClipboard.swf" loop="false" menu="false" quality="best" bgcolor="#ffffff" name="ZeroClipboardMovie_1" allowscriptaccess="always" allowfullscreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="id=1&amp;width=23&amp;height=12" wmode="transparent" width="23" align="middle" height="12"></div></span><span data-mod="popu_169"> <a href="#" class="PrintSource" title="print" onclick="dp.sh.Toolbar.Command('PrintSource',this);return false;">print</a></span><a href="#" class="About" title="?" onclick="dp.sh.Toolbar.Command('About',this);return false;">?</a><span class="tracking-ad" data-mod="popu_167"><a href="https://code.csdn.net/snippets/1634425" target="_blank" title="在CODE上查看代码片" style="text-indent:0;"><img src="https://code.csdn.net/assets/CODE_ico.png" alt="在CODE上查看代码片" style="position:relative;top:1px;left:2px;" width="12" height="12"></a></span><span class="tracking-ad" data-mod="popu_170"><a href="https://code.csdn.net/snippets/1634425/fork" target="_blank" title="派生到我的代码片" style="text-indent:0;"><img src="https://code.csdn.net/assets/ico_fork.svg" alt="派生到我的代码片" style="position:relative;top:2px;left:2px;" width="12" height="12"></a></span></div></div><ol start="1" class="dp-c"><li class="alt"><span><span>typedef&nbsp;struct&nbsp;_zval_struct&nbsp;zval;&nbsp;&nbsp;</span></span></li></ol><div class="save_code tracking-ad" data-mod="popu_249" style="display: none;"><a href="javascript:;" target="_blank"><img src="http://static.blog.csdn.net/images/save_snippets_01.png"></a></div></div><pre code_snippet_id="1634425" snippet_file_name="blog_20160404_1_8489026" name="code" class="php" style="display: none;"> typedef struct _zval_struct zval;</pre><div class="dp-highlighter bg_php"><div class="bar" style="display: block;"><div class="tools"><b>[php]</b> <a href="#" class="ViewSource" title="view plain" onclick="dp.sh.Toolbar.Command('ViewSource',this);return false;">view plain</a><span data-mod="popu_168"> <a href="#" class="CopyToClipboard" title="copy" onclick="dp.sh.Toolbar.Command('CopyToClipboard',this);return false;">copy</a><div style="position: absolute; left: 428px; top: 1116px; width: 23px; height: 12px; z-index: 99;"><embed id="ZeroClipboardMovie_2" src="http://static.blog.csdn.net/scripts/ZeroClipboard/ZeroClipboard.swf" loop="false" menu="false" quality="best" bgcolor="#ffffff" name="ZeroClipboardMovie_2" allowscriptaccess="always" allowfullscreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="id=2&amp;width=23&amp;height=12" wmode="transparent" width="23" align="middle" height="12"></div></span><span data-mod="popu_169"> <a href="#" class="PrintSource" title="print" onclick="dp.sh.Toolbar.Command('PrintSource',this);return false;">print</a></span><a href="#" class="About" title="?" onclick="dp.sh.Toolbar.Command('About',this);return false;">?</a><span class="tracking-ad" data-mod="popu_167"><a href="https://code.csdn.net/snippets/1634425" target="_blank" title="在CODE上查看代码片" style="text-indent:0;"><img src="https://code.csdn.net/assets/CODE_ico.png" alt="在CODE上查看代码片" style="position:relative;top:1px;left:2px;" width="12" height="12"></a></span><span class="tracking-ad" data-mod="popu_170"><a href="https://code.csdn.net/snippets/1634425/fork" target="_blank" title="派生到我的代码片" style="text-indent:0;"><img src="https://code.csdn.net/assets/ico_fork.svg" alt="派生到我的代码片" style="position:relative;top:2px;left:2px;" width="12" height="12"></a></span></div></div><ol start="1" class="dp-c"><li class="alt"><span><span>typedef&nbsp;union&nbsp;_zvalue_value&nbsp;{&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;long&nbsp;lval;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*&nbsp;long&nbsp;value&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;double&nbsp;dval;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*&nbsp;double&nbsp;value&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;struct&nbsp;{&nbsp;&nbsp;</span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;char&nbsp;*val;&nbsp;<span class="comment">//4字节</span><span>&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;int&nbsp;len;&nbsp;&nbsp;&nbsp;<span class="comment">//4字节</span><span>&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;}&nbsp;str;&nbsp;&nbsp;</span></li><li class=""><span>&nbsp;&nbsp;&nbsp;HashTable&nbsp;*ht;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*&nbsp;hash&nbsp;table&nbsp;value&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;zend_object_value&nbsp;obj;&nbsp;&nbsp;</span></li><li class=""><span>}&nbsp;zvalue_value;&nbsp;&nbsp;</span></li></ol><div class="save_code tracking-ad" data-mod="popu_249" style="display: none;"><a href="javascript:;" target="_blank"><img src="http://static.blog.csdn.net/images/save_snippets.png"></a></div></div><pre code_snippet_id="1634425" snippet_file_name="blog_20160404_2_6013009" name="code" class="php" style="display: none;"> typedef union _zvalue_value {
    long lval;      /* long value */
    double dval;    /* double value */
    struct {
    char *val; //4字节
    int len;   //4字节
    } str;
    HashTable *ht;    /* hash table value */
    zend_object_value obj;
 } zvalue_value;</pre><br>
<div class="dp-highlighter bg_php"><div class="bar" style="display: block;"><div class="tools"><b>[php]</b> <a href="#" class="ViewSource" title="view plain" onclick="dp.sh.Toolbar.Command('ViewSource',this);return false;">view plain</a><span data-mod="popu_168"> <a href="#" class="CopyToClipboard" title="copy" onclick="dp.sh.Toolbar.Command('CopyToClipboard',this);return false;">copy</a><div style="position: absolute; left: 428px; top: 1369px; width: 23px; height: 12px; z-index: 99;"><embed id="ZeroClipboardMovie_3" src="http://static.blog.csdn.net/scripts/ZeroClipboard/ZeroClipboard.swf" loop="false" menu="false" quality="best" bgcolor="#ffffff" name="ZeroClipboardMovie_3" allowscriptaccess="always" allowfullscreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="id=3&amp;width=23&amp;height=12" wmode="transparent" width="23" align="middle" height="12"></div></span><span data-mod="popu_169"> <a href="#" class="PrintSource" title="print" onclick="dp.sh.Toolbar.Command('PrintSource',this);return false;">print</a></span><a href="#" class="About" title="?" onclick="dp.sh.Toolbar.Command('About',this);return false;">?</a><span class="tracking-ad" data-mod="popu_167"><a href="https://code.csdn.net/snippets/1634425" target="_blank" title="在CODE上查看代码片" style="text-indent:0;"><img src="https://code.csdn.net/assets/CODE_ico.png" alt="在CODE上查看代码片" style="position:relative;top:1px;left:2px;" width="12" height="12"></a></span><span class="tracking-ad" data-mod="popu_170"><a href="https://code.csdn.net/snippets/1634425/fork" target="_blank" title="派生到我的代码片" style="text-indent:0;"><img src="https://code.csdn.net/assets/ico_fork.svg" alt="派生到我的代码片" style="position:relative;top:2px;left:2px;" width="12" height="12"></a></span></div></div><ol start="1" class="dp-c"><li class="alt"><span><span>struct&nbsp;_zval_struct&nbsp;{&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;<span class="comment">/*&nbsp;Variable&nbsp;information&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;zvalue_value&nbsp;value;&nbsp;&nbsp;<span class="comment">/*&nbsp;变量值保存在这里&nbsp;12字节*/</span><span>&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;zend_uint&nbsp;refcount;<span class="comment">//4字节，变量引用计数器</span><span>&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;zend_uchar&nbsp;type;&nbsp;&nbsp;&nbsp;<span class="comment">/*&nbsp;active&nbsp;type变量类型&nbsp;1字节*/</span><span>&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;zend_uchar&nbsp;is_ref;<span class="comment">//是否变量被&amp;引用，0表示非引用，1表示引用，1字节</span><span>&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;};&nbsp;&nbsp;</span></li></ol><div class="save_code tracking-ad" data-mod="popu_249"><a href="javascript:;" target="_blank"><img src="http://static.blog.csdn.net/images/save_snippets.png"></a></div></div><pre code_snippet_id="1634425" snippet_file_name="blog_20160404_3_2490998" name="code" class="php" style="display: none;"> struct _zval_struct {
    /* Variable information */
    zvalue_value value;  /* 变量值保存在这里 12字节*/
    zend_uint refcount;//4字节，变量引用计数器
    zend_uchar type;   /* active type变量类型 1字节*/
    zend_uchar is_ref;//是否变量被&amp;引用，0表示非引用，1表示引用，1字节
    };</pre>
<p></p>
<div style="font-family:微软雅黑; font-size:14px; line-height:21px; widows:auto"><br>
</div>
<span style="color:rgb(51,51,51); font-family:微软雅黑,'microsoft yahei',Arial,Helvetica,sans-serif,Tahoma,Verdana,simsun,sans-serif; font-size:15px; line-height:25px">2.<span style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">zend_uchar
 type</span><br>
</span>
<div style="font-family:微软雅黑; font-size:14px; line-height:21px; widows:auto"><span style="color:rgb(51,51,51); font-family:Arial"><span style="white-space:pre"></span>PHP中的变量包括</span><span style="color:rgb(0,0,255); font-family:Arial">四种标量类型</span><span style="color:rgb(51,51,51); font-family:Arial">（bool,int,float,string），</span><span style="color:rgb(0,0,255); font-family:Arial">两种复合类型</span><span style="color:rgb(51,51,51); font-family:Arial">（array,
 object）和</span><span style="color:rgb(0,0,255); font-family:Arial">两种特殊的类型</span><span style="color:rgb(51,51,51); font-family:Arial">（resource 和NULL）。在zend内部，这些类型对应于下面的宏（代码位置 phpsrc/Zend/zend.h）</span><span style="font-family:微软雅黑,'microsoft yahei',Arial,Helvetica,sans-serif,Tahoma,Verdana,simsun,sans-serif; font-size:15px; widows:auto; background-color:inherit">&nbsp;Zend根据type值来决定访问value的哪个成员，可用值如下：</span></div>
<p></p>
<p><span style="white-space:pre"><span style="font-family:微软雅黑,microsoft yahei,Arial,Helvetica,sans-serif,Tahoma,Verdana,simsun,sans-serif; color:#333333"><span style="font-size:15px; line-height:25px"><span style="white-space:pre"><img src="http://img.blog.csdn.net/20160404194942266?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt=""></span><br>
</span></span>3</span>.<span style="color:rgb(51,51,51); font-family:Arial; line-height:26px; font-size:14px; widows:auto; white-space:pre">zend_uint refcount__gc &nbsp;</span><span style="white-space:pre"></span></p>
<div style="font-family:微软雅黑; font-size:14px; line-height:21px; widows:auto"><br>
</div>
<div style="font-family:微软雅黑; font-size:14px; line-height:21px; widows:auto"><span style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"><span style="white-space:pre"></span>该值实际上是一个计数器，用来保存有多少变量（或者符号，</span><span style="font-family:Arial; font-size:14px; line-height:26px; color:rgb(0,0,255)">symbols</span><span style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">,所有的符号都存在符号表（symble
 table）中, 不同的作用域使用不同的符号表，关于这一点，我们之后会论述）指向该zval。在变量生成时，其refcount=1，典型的赋值操作如$a = $b会令zval的refcount加1，而unset操作会相应的减1。在PHP5.3之前，使用引用计数的机制来实现GC，如果一个zval的refcount较少到0，那么Zend引擎会认为没有任何变量指向该zval，因此会释放该zval所占的内存空间。但，事情有时并不会那么简单。后面我们会看到，</span><span style="font-family:Arial; font-size:14px; line-height:26px"><span style="color:#990000">单纯的引用计数机制无法GC掉循环引用的zval(详见后举例3)</span></span><span style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">，即使指向该zval的变量已经被unset，从而导致了内存泄露（</span><span style="font-family:Arial; font-size:14px; line-height:26px; color:rgb(0,0,255)">Memory
 Leak</span><span style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">）。</span><br>
</div>
<div style="font-family:微软雅黑; font-size:14px; line-height:21px; widows:auto">
<div style="font-family:微软雅黑; font-size:14px; line-height:21px; widows:auto"><br style="background-color:inherit">
</div>
<br>
<span style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">4.is_ref__gc</span><br>
</div>
.
<div style="font-family:微软雅黑; font-size:14px; line-height:21px; widows:auto"><span style="color:rgb(51,51,51); font-family:Arial; line-height:26px"><span style="white-space:pre"></span>这个字段用于标记变量是否是引用变量。对于普通的变量，该值为0，而对于引用型的变量，该值为1。这个变量会影响zval的共享、分离等。关于这点，我们之后会有论述。</span></div>
<p></p>
<p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
正如名字所示，ref_count__gc和<span style="color:rgb(0,0,255)">is_ref__gc</span>是PHP的GC机制所需的很重要的两个字段，这两个字段的值，可以通过xdebug等调试工具查看。</p>
<p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
<br>
</p>
<p style="color:rgb(51,51,51); font-family:Arial; line-height:26px"><span style="font-size:24px">下面我们围绕zval，展开叙述，PHP变量到底是怎么个存储机制。</span></p>
<p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
<span style="white-space:pre"></span>Xdebug的安装我在前边PHPstorm Xdebug调试也介绍过，这里不赘述，请看：&nbsp;<a target="_blank" href="http://blog.csdn.net/ty_hf/article/details/50768702" style="widows:auto; color:rgb(0,0,0); text-decoration:none; font-family:'Microsoft YaHei'; font-size:20px; line-height:30px">phpstorm+Xdebug断点调试PHP</a></p>
<p style="font-family:Arial; line-height:26px"><span style="font-size:14px; color:rgb(51,51,51); white-space:pre"></span><span style="color:#333333; font-size:14px">安装成功后，</span><span style="font-size:14px; color:rgb(51,51,51); font-family:Arial; line-height:26px">你的脚本中，可以通过</span><span style="font-family:Arial; line-height:26px"><span style="font-size:24px; color:#006600">xdebug_debug_zval</span></span><span style="font-size:14px; color:rgb(51,51,51); font-family:Arial; line-height:26px">打印Zval的信息，用法：</span></p>
<p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
<span style="white-space:pre"></span></p>
<div class="dp-highlighter bg_php"><div class="bar" style="display: block;"><div class="tools"><b>[php]</b> <a href="#" class="ViewSource" title="view plain" onclick="dp.sh.Toolbar.Command('ViewSource',this);return false;">view plain</a><span data-mod="popu_168"> <a href="#" class="CopyToClipboard" title="copy" onclick="dp.sh.Toolbar.Command('CopyToClipboard',this);return false;">copy</a><div style="position: absolute; left: 428px; top: 2488px; width: 23px; height: 12px; z-index: 99;"><embed id="ZeroClipboardMovie_4" src="http://static.blog.csdn.net/scripts/ZeroClipboard/ZeroClipboard.swf" loop="false" menu="false" quality="best" bgcolor="#ffffff" name="ZeroClipboardMovie_4" allowscriptaccess="always" allowfullscreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="id=4&amp;width=23&amp;height=12" wmode="transparent" width="23" align="middle" height="12"></div></span><span data-mod="popu_169"> <a href="#" class="PrintSource" title="print" onclick="dp.sh.Toolbar.Command('PrintSource',this);return false;">print</a></span><a href="#" class="About" title="?" onclick="dp.sh.Toolbar.Command('About',this);return false;">?</a><span class="tracking-ad" data-mod="popu_167"><a href="https://code.csdn.net/snippets/1634425" target="_blank" title="在CODE上查看代码片" style="text-indent:0;"><img src="https://code.csdn.net/assets/CODE_ico.png" alt="在CODE上查看代码片" style="position:relative;top:1px;left:2px;" width="12" height="12"></a></span><span class="tracking-ad" data-mod="popu_170"><a href="https://code.csdn.net/snippets/1634425/fork" target="_blank" title="派生到我的代码片" style="text-indent:0;"><img src="https://code.csdn.net/assets/ico_fork.svg" alt="派生到我的代码片" style="position:relative;top:2px;left:2px;" width="12" height="12"></a></span></div></div><ol start="1" class="dp-c"><li class="alt"><span><span class="vars">$var</span><span>&nbsp;=&nbsp;1;&nbsp;&nbsp;</span></span></li><li class=""><span>debug_zval_dump(<span class="vars">$var</span><span>);&nbsp;&nbsp;</span></span></li><li class="alt"><span><span class="vars">$var_dup</span><span>&nbsp;=&nbsp;</span><span class="vars">$var</span><span>;&nbsp;&nbsp;</span></span></li><li class=""><span>debug_zval_dump(<span class="vars">$var</span><span>);&nbsp;&nbsp;</span></span></li></ol><div class="save_code tracking-ad" data-mod="popu_249" style="display: none;"><a href="javascript:;" target="_blank"><img src="http://static.blog.csdn.net/images/save_snippets.png"></a></div></div><pre code_snippet_id="1634425" snippet_file_name="blog_20160404_4_5696581" name="code" class="php" style="display: none;"> $var = 1;
 debug_zval_dump($var);
 $var_dup = $var;
 debug_zval_dump($var);</pre><br>
<p></p>
<p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
<span style="white-space:pre"></span></p>
<div style="font-family:微软雅黑; font-size:14px; line-height:21px; widows:auto"><br style="background-color:inherit">
</div>
<h2><a name="t0"></a><span style="white-space:pre"><strong>实例</strong></span><strong>一：</strong></h2>
<p></p>
<p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
</p>
<div class="dp-highlighter bg_php"><div class="bar" style="display: block;"><div class="tools"><b>[php]</b> <a href="#" class="ViewSource" title="view plain" onclick="dp.sh.Toolbar.Command('ViewSource',this);return false;">view plain</a><span data-mod="popu_168"> <a href="#" class="CopyToClipboard" title="copy" onclick="dp.sh.Toolbar.Command('CopyToClipboard',this);return false;">copy</a><div style="position: absolute; left: 428px; top: 2695px; width: 23px; height: 12px; z-index: 99;"><embed id="ZeroClipboardMovie_5" src="http://static.blog.csdn.net/scripts/ZeroClipboard/ZeroClipboard.swf" loop="false" menu="false" quality="best" bgcolor="#ffffff" name="ZeroClipboardMovie_5" allowscriptaccess="always" allowfullscreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="id=5&amp;width=23&amp;height=12" wmode="transparent" width="23" align="middle" height="12"></div></span><span data-mod="popu_169"> <a href="#" class="PrintSource" title="print" onclick="dp.sh.Toolbar.Command('PrintSource',this);return false;">print</a></span><a href="#" class="About" title="?" onclick="dp.sh.Toolbar.Command('About',this);return false;">?</a><span class="tracking-ad" data-mod="popu_167"><a href="https://code.csdn.net/snippets/1634425" target="_blank" title="在CODE上查看代码片" style="text-indent:0;"><img src="https://code.csdn.net/assets/CODE_ico.png" alt="在CODE上查看代码片" style="position:relative;top:1px;left:2px;" width="12" height="12"></a></span><span class="tracking-ad" data-mod="popu_170"><a href="https://code.csdn.net/snippets/1634425/fork" target="_blank" title="派生到我的代码片" style="text-indent:0;"><img src="https://code.csdn.net/assets/ico_fork.svg" alt="派生到我的代码片" style="position:relative;top:2px;left:2px;" width="12" height="12"></a></span></div></div><ol start="1" class="dp-c"><li class="alt"><span><span class="vars">$a</span><span>&nbsp;=&nbsp;1;&nbsp;&nbsp;</span></span></li><li class=""><span><span class="vars">$b</span><span>&nbsp;=&nbsp;</span><span class="vars">$a</span><span>;&nbsp;&nbsp;</span></span></li><li class="alt"><span><span class="vars">$c</span><span>&nbsp;=&nbsp;</span><span class="vars">$b</span><span>;&nbsp;&nbsp;</span></span></li><li class=""><span><span class="vars">$d</span><span>&nbsp;=&nbsp;&amp;</span><span class="vars">$c</span><span>;&nbsp;</span><span class="comment">//&nbsp;在一堆非引用赋值中，插入一个引用</span><span>&nbsp;&nbsp;</span></span></li></ol><div class="save_code tracking-ad" data-mod="popu_249"><a href="javascript:;" target="_blank"><img src="http://static.blog.csdn.net/images/save_snippets.png"></a></div></div><pre code_snippet_id="1634425" snippet_file_name="blog_20160404_5_7714468" name="code" class="php" style="display: none;">    $a = 1;
    $b = $a;
    $c = $b;
    $d = &amp;$c; // 在一堆非引用赋值中，插入一个引用
</pre>
<p></p>
<div style="font-family:微软雅黑; font-size:14px; line-height:21px; widows:auto"><br style="background-color:inherit">
</div>
<br>
<span style="color:rgb(51,51,51); font-family:微软雅黑,'microsoft yahei',Arial,Helvetica,sans-serif,Tahoma,Verdana,simsun,sans-serif; font-size:15px; line-height:25px">&nbsp;&nbsp;</span><span style="color:rgb(51,51,51); font-family:微软雅黑,'microsoft yahei',Arial,Helvetica,sans-serif,Tahoma,Verdana,simsun,sans-serif; font-size:15px; line-height:25px">整个过程图示如下：</span><br>
<img src="http://img.blog.csdn.net/20160404201622636?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt=""><br>
<p></p>
<p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
---------------------------------------------------------</p>
<h2 style="text-indent:12px; font-size:14px"><a name="t1"></a><span style="font-family:Helvetica Neue,Helvetica,Arial,sans-serif; color:#222222"><span style="line-height:18px"><strong>实例二：</strong></span></span></h2>
<p style="text-indent:12px; font-size:14px"><span style="font-family:Helvetica Neue,Helvetica,Arial,sans-serif; color:#222222"><span style="line-height:18px"></span></span></p>
<div class="dp-highlighter bg_php"><div class="bar" style="display: block;"><div class="tools"><b>[php]</b> <a href="#" class="ViewSource" title="view plain" onclick="dp.sh.Toolbar.Command('ViewSource',this);return false;">view plain</a><span data-mod="popu_168"> <a href="#" class="CopyToClipboard" title="copy" onclick="dp.sh.Toolbar.Command('CopyToClipboard',this);return false;">copy</a><div style="position: absolute; left: 428px; top: 3306px; width: 23px; height: 12px; z-index: 99;"><embed id="ZeroClipboardMovie_6" src="http://static.blog.csdn.net/scripts/ZeroClipboard/ZeroClipboard.swf" loop="false" menu="false" quality="best" bgcolor="#ffffff" name="ZeroClipboardMovie_6" allowscriptaccess="always" allowfullscreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="id=6&amp;width=23&amp;height=12" wmode="transparent" width="23" align="middle" height="12"></div></span><span data-mod="popu_169"> <a href="#" class="PrintSource" title="print" onclick="dp.sh.Toolbar.Command('PrintSource',this);return false;">print</a></span><a href="#" class="About" title="?" onclick="dp.sh.Toolbar.Command('About',this);return false;">?</a><span class="tracking-ad" data-mod="popu_167"><a href="https://code.csdn.net/snippets/1634425" target="_blank" title="在CODE上查看代码片" style="text-indent:0;"><img src="https://code.csdn.net/assets/CODE_ico.png" alt="在CODE上查看代码片" style="position:relative;top:1px;left:2px;" width="12" height="12"></a></span><span class="tracking-ad" data-mod="popu_170"><a href="https://code.csdn.net/snippets/1634425/fork" target="_blank" title="派生到我的代码片" style="text-indent:0;"><img src="https://code.csdn.net/assets/ico_fork.svg" alt="派生到我的代码片" style="position:relative;top:2px;left:2px;" width="12" height="12"></a></span></div></div><ol start="1" class="dp-c"><li class="alt"><span><span class="vars">$a</span><span>&nbsp;=&nbsp;1;&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;<span class="vars">$b</span><span>&nbsp;=&nbsp;&amp;</span><span class="vars">$a</span><span>;&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;<span class="vars">$c</span><span>&nbsp;=&nbsp;&amp;</span><span class="vars">$b</span><span>;&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;<span class="vars">$d</span><span>&nbsp;=&nbsp;</span><span class="vars">$c</span><span>;&nbsp;</span><span class="comment">//&nbsp;在一堆引用赋值中，插入一个非引用</span><span>&nbsp;&nbsp;</span></span></li></ol><div class="save_code tracking-ad" data-mod="popu_249"><a href="javascript:;" target="_blank"><img src="http://static.blog.csdn.net/images/save_snippets.png"></a></div></div><pre code_snippet_id="1634425" snippet_file_name="blog_20160404_6_396664" name="code" class="php" style="display: none;">   $a = 1;
    $b = &amp;$a;
    $c = &amp;$b;
    $d = $c; // 在一堆引用赋值中，插入一个非引用</pre><br>
<p></p>
<div style="font-family:微软雅黑; font-size:14px; line-height:21px; widows:auto"><br>
</div>
<span style="color:rgb(51,51,51); font-family:微软雅黑,'microsoft yahei',Arial,Helvetica,sans-serif,Tahoma,Verdana,simsun,sans-serif; font-size:15px; line-height:25px">&nbsp;&nbsp;</span><span style="color:rgb(51,51,51); font-family:微软雅黑,'microsoft yahei',Arial,Helvetica,sans-serif,Tahoma,Verdana,simsun,sans-serif; font-size:15px; line-height:25px">整个过程图示如下：</span><br>
<p></p>
<p style="text-indent:12px; font-size:14px"><span style="font-family:Helvetica Neue,Helvetica,Arial,sans-serif; color:#222222"><span style="line-height:18px"><span style="color:rgb(51,51,51); font-family:微软雅黑,'microsoft yahei',Arial,Helvetica,sans-serif,Tahoma,Verdana,simsun,sans-serif; font-size:15px; line-height:25px"><img src="http://img.blog.csdn.net/20160404202921641?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt=""><br>
</span></span></span></p>
<p style="text-indent:12px"><span style="font-family:Helvetica Neue,Helvetica,Arial,sans-serif"><span style="line-height:18px"><span style="font-family:微软雅黑,'microsoft yahei',Arial,Helvetica,sans-serif,Tahoma,Verdana,simsun,sans-serif; line-height:25px"></span></span></span></p>
<div style="color:rgb(51,51,51); font-size:14px; font-family:微软雅黑; line-height:21px; widows:auto">
<br style="background-color:inherit">
</div>
<br>
<p></p>
<p style="font-family:Arial; line-height:26px"><br>
<span style="font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; line-height:18px"><span style="color:rgb(34,34,34); font-size:14px">通过实例一、二，展现了，这就是PHP的</span><strong><span style="font-size:18px; color:#339999">copy on write写时分离机制</span><span style="color:#222222"><span style="font-size:14px">、</span></span></strong></span><span style="widows:auto; font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; line-height:18px"><span style="color:#222222"><span style="font-size:14px"><span style="font-size:18px; color:rgb(51,153,153)">change
 on write写时改变机制</span></span></span></span></p>
<p style="font-family:Arial; line-height:26px"><strong>过程：</strong></p>
<p style="font-family:Arial; line-height:26px"><span style="color:rgb(34,34,34); font-size:14px; font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; line-height:18px; text-indent:12px"><span style="white-space:pre"></span>PHP在修改一个变量以前，会首先查看这个变量的refcount，如果refcount大于1，PHP就会执行一个分离的例程，&nbsp;</span></p>
<p style="font-family:Arial; line-height:26px"><span style="color:rgb(34,34,34); font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; font-size:14px; line-height:18px">&nbsp; &nbsp; &nbsp;对于上面的实例一代码，当执行到第四行的时候，PHP发现$c指向的zval的</span><span style="font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; font-size:14px; line-height:18px"><span style="color:#993300">refcount大于1</span></span><span style="color:rgb(34,34,34); font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; font-size:14px; line-height:18px">，那么PHP就会复制一个新的zval出来，将原zval的refcount减1，并修改symbol_table，使得$a,$b和$c分离(Separation)。这个机制就是所谓的copy
 on write(写时复制/写时分离)。把$d指向的新zval的is_ref的值 == 1 ，这个机制叫做change on write(写时改变)</span></p>
<div style="color:rgb(51,51,51); font-size:15px"><span style="color:rgb(34,34,34); font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; line-height:18px"></span>
<div style="font-family:微软雅黑; font-size:14px; line-height:21px; widows:auto"><br>
</div>
<div style="font-family:微软雅黑; font-size:14px; line-height:21px; widows:auto"><strong>结论：</strong></div>
</div>
<h2><a name="t2"></a>
<p style="text-indent:12px; font-family:Arial; line-height:26px"><span style="font-size:14px"><span style="color:#339999"><span style="white-space:pre"></span>分离</span>指的是：分离两个变量存储的zval的位置，让分开不指向同一个空间！ (那如何判定是否要分离呢，依据是什么？见下边)</span></p>
<p style="text-indent:12px; font-family:Arial; line-height:26px"><span style="font-size:14px"><span style="color:#339999"><span style="white-space:pre"></span>改变</span>指的是，有&amp;引用赋值时，要把新开辟的zval 的 is_ref 赋值为1</span></p>
</h2>
<h2><a name="t3"></a><br>
</h2>
判定是否分离的条件：如果is_ref =1 或recount == 1,则不分离
<div><div class="dp-highlighter bg_php"><div class="bar" style="display: block;"><div class="tools"><b>[php]</b> <a href="#" class="ViewSource" title="view plain" onclick="dp.sh.Toolbar.Command('ViewSource',this);return false;">view plain</a><span data-mod="popu_168"> <a href="#" class="CopyToClipboard" title="copy" onclick="dp.sh.Toolbar.Command('CopyToClipboard',this);return false;">copy</a><div style="position: absolute; left: 428px; top: 4202px; width: 23px; height: 12px; z-index: 99;"><embed id="ZeroClipboardMovie_7" src="http://static.blog.csdn.net/scripts/ZeroClipboard/ZeroClipboard.swf" loop="false" menu="false" quality="best" bgcolor="#ffffff" name="ZeroClipboardMovie_7" allowscriptaccess="always" allowfullscreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="id=7&amp;width=23&amp;height=12" wmode="transparent" width="23" align="middle" height="12"></div></span><span data-mod="popu_169"> <a href="#" class="PrintSource" title="print" onclick="dp.sh.Toolbar.Command('PrintSource',this);return false;">print</a></span><a href="#" class="About" title="?" onclick="dp.sh.Toolbar.Command('About',this);return false;">?</a><span class="tracking-ad" data-mod="popu_167"><a href="https://code.csdn.net/snippets/1634425" target="_blank" title="在CODE上查看代码片" style="text-indent:0;"><img src="https://code.csdn.net/assets/CODE_ico.png" alt="在CODE上查看代码片" style="position:relative;top:1px;left:2px;" width="12" height="12"></a></span><span class="tracking-ad" data-mod="popu_170"><a href="https://code.csdn.net/snippets/1634425/fork" target="_blank" title="派生到我的代码片" style="text-indent:0;"><img src="https://code.csdn.net/assets/ico_fork.svg" alt="派生到我的代码片" style="position:relative;top:2px;left:2px;" width="12" height="12"></a></span></div></div><ol start="1" class="dp-c"><li class="alt"><span><span class="keyword">if</span><span>((*val)-&gt;is_ref&nbsp;||&nbsp;(*val)-&gt;refcount&lt;2){&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//不执行Separation</span><span>&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;;<span class="comment">//process</span><span>&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;}&nbsp;&nbsp;</span></li></ol><div class="save_code tracking-ad" data-mod="popu_249"><a href="javascript:;" target="_blank"><img src="http://static.blog.csdn.net/images/save_snippets.png"></a></div></div><pre code_snippet_id="1634425" snippet_file_name="blog_20160404_7_8826500" name="code" class="php" style="display: none;">if((*val)-&gt;is_ref || (*val)-&gt;refcount&lt;2){
          //不执行Separation
        ... ;//process
  }</pre><br>
<br>
<br>
<br>
<span style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">---------------------------------------------------------------------------------------------------</span>
<div style="font-family:微软雅黑; font-size:14px; line-height:21px; widows:auto"><br>
</div>
<h2 style="text-indent:12px"><a name="t4"></a><span style="font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; color:rgb(34,34,34)"><span style="line-height:18px"><span style="font-size:18px">实例三：(内存是如何泄漏的)</span></span></span></h2>
<span style="white-space:pre"></span>
<h3 style="margin:0px; padding:0px; color:rgb(51,51,51); font-family:Arial; line-height:26px"><a name="t5"></a>
<span style="font-size:14px">数组变量与普通变量生成的zval非常类似，但也有很大不同</span></h3>
<div><span style="font-size:14px">举例：</span></div>
<div><span style="font-size:14px"><br>
</span></div>
<div><span style="font-size:14px"></span><div class="dp-highlighter bg_php"><div class="bar" style="display: block;"><div class="tools"><b>[php]</b> <a href="#" class="ViewSource" title="view plain" onclick="dp.sh.Toolbar.Command('ViewSource',this);return false;">view plain</a><span data-mod="popu_168"> <a href="#" class="CopyToClipboard" title="copy" onclick="dp.sh.Toolbar.Command('CopyToClipboard',this);return false;">copy</a><div style="position: absolute; left: 428px; top: 4583px; width: 23px; height: 12px; z-index: 99;"><embed id="ZeroClipboardMovie_8" src="http://static.blog.csdn.net/scripts/ZeroClipboard/ZeroClipboard.swf" loop="false" menu="false" quality="best" bgcolor="#ffffff" name="ZeroClipboardMovie_8" allowscriptaccess="always" allowfullscreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="id=8&amp;width=23&amp;height=12" wmode="transparent" width="23" align="middle" height="12"></div></span><span data-mod="popu_169"> <a href="#" class="PrintSource" title="print" onclick="dp.sh.Toolbar.Command('PrintSource',this);return false;">print</a></span><a href="#" class="About" title="?" onclick="dp.sh.Toolbar.Command('About',this);return false;">?</a><span class="tracking-ad" data-mod="popu_167"><a href="https://code.csdn.net/snippets/1634425" target="_blank" title="在CODE上查看代码片" style="text-indent:0;"><img src="https://code.csdn.net/assets/CODE_ico.png" alt="在CODE上查看代码片" style="position:relative;top:1px;left:2px;" width="12" height="12"></a></span><span class="tracking-ad" data-mod="popu_170"><a href="https://code.csdn.net/snippets/1634425/fork" target="_blank" title="派生到我的代码片" style="text-indent:0;"><img src="https://code.csdn.net/assets/ico_fork.svg" alt="派生到我的代码片" style="position:relative;top:2px;left:2px;" width="12" height="12"></a></span></div></div><ol start="1" class="dp-c"><li class="alt"><span><span class="vars">$a</span><span>&nbsp;=&nbsp;</span><span class="vars">$array</span><span>(</span><span class="string">'one'</span><span>);&nbsp;&nbsp;&nbsp;&nbsp;</span></span></li><li class=""><span><span class="vars">$a</span><span>[]&nbsp;=&nbsp;&amp;</span><span class="vars">$a</span><span>;&nbsp;&nbsp;&nbsp;&nbsp;</span></span></li><li class="alt"><span>xdebug_debug_zval(<span class="string">'a'</span><span>);&nbsp;&nbsp;&nbsp;</span></span></li></ol><div class="save_code tracking-ad" data-mod="popu_249"><a href="javascript:;" target="_blank"><img src="http://static.blog.csdn.net/images/save_snippets.png"></a></div></div><pre code_snippet_id="1634425" snippet_file_name="blog_20160404_8_7048594" name="code" class="php" style="display: none;">$a = $array('one');  
$a[] = &amp;$a;  
xdebug_debug_zval('a'); </pre></div>
<div><br>
</div>
<span style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">debug_zval_dump打印出zval的结构是：</span></div>
<div><span style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"></span><div class="dp-highlighter bg_php"><div class="bar" style="display: block;"><div class="tools"><b>[php]</b> <a href="#" class="ViewSource" title="view plain" onclick="dp.sh.Toolbar.Command('ViewSource',this);return false;">view plain</a><span data-mod="popu_168"> <a href="#" class="CopyToClipboard" title="copy" onclick="dp.sh.Toolbar.Command('CopyToClipboard',this);return false;">copy</a><div style="position: absolute; left: 428px; top: 4753px; width: 23px; height: 12px; z-index: 99;"><embed id="ZeroClipboardMovie_9" src="http://static.blog.csdn.net/scripts/ZeroClipboard/ZeroClipboard.swf" loop="false" menu="false" quality="best" bgcolor="#ffffff" name="ZeroClipboardMovie_9" allowscriptaccess="always" allowfullscreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="id=9&amp;width=23&amp;height=12" wmode="transparent" width="23" align="middle" height="12"></div></span><span data-mod="popu_169"> <a href="#" class="PrintSource" title="print" onclick="dp.sh.Toolbar.Command('PrintSource',this);return false;">print</a></span><a href="#" class="About" title="?" onclick="dp.sh.Toolbar.Command('About',this);return false;">?</a><span class="tracking-ad" data-mod="popu_167"><a href="https://code.csdn.net/snippets/1634425" target="_blank" title="在CODE上查看代码片" style="text-indent:0;"><img src="https://code.csdn.net/assets/CODE_ico.png" alt="在CODE上查看代码片" style="position:relative;top:1px;left:2px;" width="12" height="12"></a></span><span class="tracking-ad" data-mod="popu_170"><a href="https://code.csdn.net/snippets/1634425/fork" target="_blank" title="派生到我的代码片" style="text-indent:0;"><img src="https://code.csdn.net/assets/ico_fork.svg" alt="派生到我的代码片" style="position:relative;top:2px;left:2px;" width="12" height="12"></a></span></div></div><ol start="1" class="dp-c"><li class="alt"><span><span>a:&nbsp;(refcount=2,&nbsp;is_ref=1)=</span><span class="keyword">array</span><span>&nbsp;(&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;=&gt;&nbsp;(refcount=1,&nbsp;is_ref=0)=<span class="string">'one'</span><span>,&nbsp;&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;=&gt;&nbsp;(refcount=2,&nbsp;is_ref=1)=...&nbsp;&nbsp;</span></li><li class=""><span>)&nbsp;&nbsp;</span></li></ol><div class="save_code tracking-ad" data-mod="popu_249"><a href="javascript:;" target="_blank"><img src="http://static.blog.csdn.net/images/save_snippets.png"></a></div></div><pre code_snippet_id="1634425" snippet_file_name="blog_20160404_9_5478430" name="code" class="php" style="display: none;">a: (refcount=2, is_ref=1)=array (
    0 =&gt; (refcount=1, is_ref=0)='one', 
    1 =&gt; (refcount=2, is_ref=1)=...
)</pre>
<div style="font-family:微软雅黑; font-size:14px; line-height:21px; widows:auto"><br>
</div>
<span style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">上述输出中，…表示指向原始数组，因而这是一个循环的引用。如下图所示：</span></div>
<div>
<div style="font-family:微软雅黑; font-size:14px; line-height:21px; widows:auto"><img src="http://img.blog.csdn.net/20160404210358201?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt=""><br>
</div>
</div>
<div style="font-family:微软雅黑; font-size:14px; line-height:21px; widows:auto"><br>
</div>
<div style="font-family:微软雅黑; font-size:14px; line-height:21px; widows:auto">
<div style="font-family:微软雅黑; font-size:14px; line-height:21px; widows:auto"><br style="background-color:inherit">
</div>
<br>
<br>
<br>
<span style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">现在，我们对$a执行unset操作，这会在symbol table中删除相应的symbol,同时，zval的refcount减1（之前为2），也就是说，现在的zval应该是这样的结构：</span><br>
</div>
<div style="font-family:微软雅黑; font-size:14px; line-height:21px; widows:auto"><span style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"></span><div class="dp-highlighter bg_php"><div class="bar" style="display: block;"><div class="tools"><b>[php]</b> <a href="#" class="ViewSource" title="view plain" onclick="dp.sh.Toolbar.Command('ViewSource',this);return false;">view plain</a><span data-mod="popu_168"> <a href="#" class="CopyToClipboard" title="copy" onclick="dp.sh.Toolbar.Command('CopyToClipboard',this);return false;">copy</a><div style="position: absolute; left: 428px; top: 5313px; width: 23px; height: 12px; z-index: 99;"><embed id="ZeroClipboardMovie_10" src="http://static.blog.csdn.net/scripts/ZeroClipboard/ZeroClipboard.swf" loop="false" menu="false" quality="best" bgcolor="#ffffff" name="ZeroClipboardMovie_10" allowscriptaccess="always" allowfullscreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="id=10&amp;width=23&amp;height=12" wmode="transparent" width="23" align="middle" height="12"></div></span><span data-mod="popu_169"> <a href="#" class="PrintSource" title="print" onclick="dp.sh.Toolbar.Command('PrintSource',this);return false;">print</a></span><a href="#" class="About" title="?" onclick="dp.sh.Toolbar.Command('About',this);return false;">?</a><span class="tracking-ad" data-mod="popu_167"><a href="https://code.csdn.net/snippets/1634425" target="_blank" title="在CODE上查看代码片" style="text-indent:0;"><img src="https://code.csdn.net/assets/CODE_ico.png" alt="在CODE上查看代码片" style="position:relative;top:1px;left:2px;" width="12" height="12"></a></span><span class="tracking-ad" data-mod="popu_170"><a href="https://code.csdn.net/snippets/1634425/fork" target="_blank" title="派生到我的代码片" style="text-indent:0;"><img src="https://code.csdn.net/assets/ico_fork.svg" alt="派生到我的代码片" style="position:relative;top:2px;left:2px;" width="12" height="12"></a></span></div></div><ol start="1" class="dp-c"><li class="alt"><span><span>unset(</span><span class="vars">$a</span><span>);&nbsp;&nbsp;</span></span></li><li class=""><span>(refcount=1,&nbsp;is_ref=1)=<span class="keyword">array</span><span>&nbsp;(&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;=&gt;&nbsp;(refcount=1,&nbsp;is_ref=0)=<span class="string">'one'</span><span>,&nbsp;&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;=&gt;&nbsp;(refcount=1,&nbsp;is_ref=1)=...&nbsp;&nbsp;</span></li><li class="alt"><span>)&nbsp;&nbsp;</span></li></ol><div class="save_code tracking-ad" data-mod="popu_249" style="display: none;"><a href="javascript:;" target="_blank"><img src="http://static.blog.csdn.net/images/save_snippets.png"></a></div></div><pre code_snippet_id="1634425" snippet_file_name="blog_20160404_10_320217" name="code" class="php" style="display: none;">unset($a);
(refcount=1, is_ref=1)=array (
    0 =&gt; (refcount=1, is_ref=0)='one', 
    1 =&gt; (refcount=1, is_ref=1)=...
)</pre><br>
<img src="http://img.blog.csdn.net/20160404210602608?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="">（应该ref_count=1）<br>
</div>
<div style="font-family:微软雅黑; font-size:14px; line-height:21px; widows:auto"><span style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"><br>
</span></div>
<div style="font-size:14px; widows:auto"><span style="color:#009900"><span style="font-family:Arial"><span style="line-height:26px">（unset,其实就是打断$a在&nbsp;</span></span><span style="font-family:Arial; line-height:26px; white-space:pre; widows:auto">符号表（symble table）
 与zval 的一个指针映射关系。）</span></span></div>
<div style="font-size:14px; widows:auto"><span style="font-family:Arial; line-height:26px; white-space:pre; widows:auto"></span>
<div style="color:rgb(51,51,51); font-family:微软雅黑; font-size:14px; line-height:21px; widows:auto">
<br>
</div>
<p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
这时，不幸的事情发生了！</p>
<p style="font-family:Arial; font-size:14px; line-height:26px"><span style="color:#333333">&#12288;&#12288;Unset之后，虽然没有变量指向该zval，但是该zval却不能被GC（指PHP5.3之前的单纯引用计数机制的GC）清理掉，</span><span style="color:#660000"><strong>$a 被释放，但是$a里的$a[1]也指向了该zval，它没有被释放，导致zval的refcount均大于0。</strong></span><span style="color:#333333">这样，这些zval实际上会一直存在内存中，直到请求结束（参考SAPI的生命周期）。在此之前，这些zval占据的内存不能被使用，便白白浪费了，换句话说，</span><strong><span style="color:#990000">无法释放的内存导致了内存泄露</span></strong><span style="color:#333333">。</span></p>
<p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
&#12288;&#12288;如果这种内存泄露仅仅发生了一次或者少数几次，倒也还好，但如果是成千上万次的内存泄露，便是很大的问题了。尤其在长时间运行的脚本中（例如守护程序，一直在后台执行不会中断），由于无法回收内存，最终会导致系统“再无内存可用”，所以说，一定要避免这种操作。</p>
<br>
垃圾回收机制：</div>
<div style="font-size:14px; widows:auto"><span style="font-family:Arial; line-height:26px; white-space:pre; widows:auto"><span style="color:#333333"></span></span>
<div style="font-family:微软雅黑; font-size:14px; line-height:21px; widows:auto"><br>
</div>
<div style="font-family:微软雅黑; font-size:14px; line-height:21px; widows:auto"><span style="color:rgb(51,51,51); font-family:'Helvetica Neue',Helvetica,Arial,'PingFang SC','Hiragino Sans GB','WenQuanYi Micro Hei','Microsoft Yahei',sans-serif">1.php原来是通过引用计数器来实现内存回收，也就是是多个php变量可能会引用同一份内存，这种情况unset掉其中一个是不会释放内存的；</span><br style="color:rgb(51,51,51); font-family:'Helvetica Neue',Helvetica,Arial,'PingFang SC','Hiragino Sans GB','WenQuanYi Micro Hei','Microsoft Yahei',sans-serif">
<span style="color:rgb(51,51,51); font-family:'Helvetica Neue',Helvetica,Arial,'PingFang SC','Hiragino Sans GB','WenQuanYi Micro Hei','Microsoft Yahei',sans-serif">&nbsp; &nbsp; 例如：</span><code style="font-family:'Source Code Pro',Consolas,Menlo,Monaco,'Courier New',monospace; color:rgb(199,37,78); font-size:0.93em; background-color:rgb(249,242,244)">$a
 = 1; $b = $a; unset($a);//$a开辟的内存不会回收</code><br style="color:rgb(51,51,51); font-family:'Helvetica Neue',Helvetica,Arial,'PingFang SC','Hiragino Sans GB','WenQuanYi Micro Hei','Microsoft Yahei',sans-serif">
<span style="color:rgb(51,51,51); font-family:'Helvetica Neue',Helvetica,Arial,'PingFang SC','Hiragino Sans GB','WenQuanYi Micro Hei','Microsoft Yahei',sans-serif">2.离开了变量的作用域后变量所占用的内存就会被</span><span style="color:rgb(51,51,51); font-family:'Helvetica Neue',Helvetica,Arial,'PingFang SC','Hiragino Sans GB','WenQuanYi Micro Hei','Microsoft Yahei',sans-serif"><span style="background-color:inherit">自动清理</span></span><span style="color:rgb(51,51,51); font-family:'Helvetica Neue',Helvetica,Arial,'PingFang SC','Hiragino Sans GB','WenQuanYi Micro Hei','Microsoft Yahei',sans-serif">（不包含静态变量，静态变量在脚本加载时创建，在脚本结束时释放），</span></div>
<div style="font-family:微软雅黑; font-size:14px; line-height:21px; widows:auto"><span style="color:rgb(51,51,51); font-family:'Helvetica Neue',Helvetica,Arial,'PingFang SC','Hiragino Sans GB','WenQuanYi Micro Hei','Microsoft Yahei',sans-serif">&nbsp; &nbsp; 如函数或方法内的局部变量，对这些局部变量进行unset在函数外来看内存也是没有减少的。</span></div>
<div style="font-family:微软雅黑; font-size:14px; line-height:21px; widows:auto"><span style="font-family:Helvetica Neue,Helvetica,Arial,PingFang SC,Hiragino Sans GB,WenQuanYi Micro Hei,Microsoft Yahei,sans-serif; color:#333333; background-color:inherit">3.引用计数有个缺陷，就是当循环引用出现时，计数器没法清0，<span style="background-color:inherit">内存占用会持续到页面访问结束</span>。</span></div>
<div style="font-family:微软雅黑; font-size:14px; line-height:21px; widows:auto"><span style="font-family:Helvetica Neue,Helvetica,Arial,PingFang SC,Hiragino Sans GB,WenQuanYi Micro Hei,Microsoft Yahei,sans-serif; color:#333333; background-color:inherit">&nbsp; &nbsp; 对于这个问题PHP5.3中增加了垃圾回收机制。具体可以查阅文档：<a target="_blank" href="http://php.net/manual/zh/features.gc.php" style="color:rgb(0,154,97)">http://php.net/manual/zh/features.gc.php</a></span></div>
<div style="font-family:微软雅黑; font-size:14px; line-height:21px; widows:auto"><span style="font-family:Helvetica Neue,Helvetica,Arial,PingFang SC,Hiragino Sans GB,WenQuanYi Micro Hei,Microsoft Yahei,sans-serif; color:#333333; background-color:inherit">&nbsp; &nbsp;&nbsp;</span><span style="background-color:inherit; line-height:1.5">垃圾回收机制就是最早在Lisp中被提出，关于更多垃圾回收的信息.</span>
<div style="background-color:inherit">&nbsp; &nbsp; 参见维基百科：<span style="background-color:inherit; line-height:1.5"><span style="font-family:Helvetica Neue,Helvetica,Arial,PingFang SC,Hiragino Sans GB,WenQuanYi Micro Hei,Microsoft Yahei,sans-serif; color:#009a61">https://en.wikipedia.org/wiki/Garbage_collection_(computer_science)</span></span></div>
</div>
<div style="font-size:14px; widows:auto"><br>
</div>
<br>
</div>
<div style="font-size:14px; widows:auto"><span style="font-family:Arial; line-height:26px; white-space:pre; widows:auto"><span style="color:#333333"><br>
</span></span>
<h3 style="margin:0px; padding:0px; color:rgb(51,51,51); font-family:Arial; line-height:26px"><a name="t6"></a>
<span style="font-size:14px">本文参考文献：</span></h3>
<ol style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
<li>鸟哥的深入变量引用/分离&nbsp;&nbsp;<a target="_blank" href="http://www.laruence.com/2008/09/19/520.html" style="color:rgb(51,102,153); text-decoration:none">http://www.laruence.com/2008/09/19/520.html</a></li></ol>
<span style="font-size:14px"></span>
<div style="font-size:14px; widows:auto"><span style="font-size:14px"><br>
</span></div>
<div style="font-size:14px; widows:auto"><span style="font-size:14px"><br>
</span></div>
<div style="font-size:14px; widows:auto"><span style="font-size:14px"><br>
</span></div>
本文链接地址：<span style="font-size:14px"><a target="_blank" href="http://blog.csdn.net/ty_hf/article/details/51057954">http://blog.csdn.net/ty_hf/article/details/51057954</a></span><br style="font-size:14px">
<span style="font-size:14px">啊~终于写完了，清明三天假期也就这么过去了，今天4月4号，明天开始准备上班啦！~</span><img alt="奋斗" src="http://static.blog.csdn.net/xheditor/xheditor_emot/default/struggle.gif" style="font-size:14px"><br>
</div>
<div style="line-height:21px; widows:auto; font-size:14px">
<div style="font-family:微软雅黑"></div>
</div>
<div style="top:0px">
<div style="font-family:微软雅黑; font-size:14px; line-height:21px; widows:auto"><br style="background-color:inherit">
</div>
</div>
<div style="top:3082px"><br>
</div>
   
</div>